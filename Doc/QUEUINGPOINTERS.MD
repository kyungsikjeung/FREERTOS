# `queuingpointers.c` νν† λ¦¬μ–Ό

μ΄ λ¬Έμ„λ” `queuingpointers.c` μμ  μ½”λ“μ λ©μ , λ™μ‘ λ°©μ‹ λ° μμƒ κ²°κ³Όμ— λ€ν•΄ μ„¤λ…ν•©λ‹λ‹¤.

## 1. Objective (λ©ν‘)

μ΄ μμ μ μ£Όμ” λ©ν‘λ” FreeRTOSμ **ν(Queue)**λ¥Ό μ‚¬μ©ν•μ—¬ νƒμ¤ν¬ κ°„μ— **ν¬μΈν„°**λ¥Ό μ•μ „ν•κ² μ „λ‹¬ν•λ” λ°©λ²•μ„ μ‹μ—°ν•λ” κ²ƒμ…λ‹λ‹¤. νΉν, λ™μ μΌλ΅ ν• λ‹Ήλ λ©”λ¨λ¦¬μ μ£Όμ†(ν¬μΈν„°)λ¥Ό νλ΅ λ³΄λ‚΄κ³ , μμ‹  μΈ΅μ—μ„ ν•΄λ‹Ή λ©”λ¨λ¦¬λ¥Ό μ‚¬μ©ν•λ” λ°©λ²•μ„ λ³΄μ—¬μ¤λ‹λ‹¤. μ΄λ¥Ό ν†µν•΄ ν° λ°μ΄ν„°λ¥Ό λ³µμ‚¬ν•μ§€ μ•κ³  
ν¨μ¨μ μΌλ΅ μ „λ‹¬ν•  μ μμµλ‹λ‹¤.

## 2. κΈ°μ΅΄ νμ™€ μ°¨μ΄
```mermaid
flowchart TD
  %% π€ κ°μ„  λ°©μ‹
  subgraph After["π“¦ νμ‰ν¬μΈν„°: ν¬μΈν„°λ§ ν μ „μ†΅"]
    A10["Start"]
    A1["Task1: λ²„νΌ ν™•λ³΄ (prvGetBuffer)"]
    B1["λ²„νΌμ— λ¬Έμμ—΄ μ‘μ„± (snprintf)"]
    C1["ν¬μΈν„°λ§ νμ— μ „μ†΅ (xQueueSend)"]
    D1["ν μ €μ¥: λ²„νΌ μ£Όμ†λ§ μ €μ¥"]
    E1["Task2: ν¬μΈν„° μμ‹  (xQueueReceive)"]
    F1["Task2: λ¬Έμμ—΄ μ‚¬μ© (vPrintString)"]
    G1["λ²„νΌ λ°ν™ (prvReleaseBuffer)"]
    G12["End"]
  end

  %% π“¦ κΈ°μ΅΄ λ°©μ‹
  subgraph Before["π“¦ κΈ°μ΅΄ λ°©μ‹: λ°μ΄ν„° μμ²΄ ν μ „μ†΅"]
    A0["Start"]
    A["Task1: λ°μ΄ν„° μƒμ„± (λ¬Έμμ—΄)"]
    B["νμ— λ¬Έμμ—΄ λ°μ΄ν„° μμ²΄ λ³µμ‚¬"]
    C["ν μ €μ¥: λ¬Έμμ—΄ λ‚΄μ© ν¬ν•¨"]
    D["Task2: νμ—μ„ λ¬Έμμ—΄ λ³µμ‚¬ λ°›μ"]
    E["Task2: λ¬Έμμ—΄ μ‚¬μ© (μ: μ¶λ ¥)"]
    G2["End"]
  end

  %% After μ—°κ²°μ„ 
  A10 --> A1
  A1 --> B1
  B1 --> C1
  C1 --> D1
  D1 --> E1
  E1 --> F1
  F1 --> G1
  G1 --> G12

  %% Before μ—°κ²°μ„ 
  A0 --> A
  A --> B
  B --> C
  C --> D
  D --> E
  E --> G2

  %% π¨ μ¤νƒ€μΌ κΎΈλ―ΈκΈ°
  %% μ‹μ‘κ³Ό λ μ›ν• μ²λ¦¬
  style A10 fill:#00C853,stroke:#004D40,stroke-width:2px
  style G12 fill:#0091EA,stroke:#01579B,stroke-width:2px
  style A0 fill:#00C853,stroke:#004D40,stroke-width:2px
  style G2 fill:#0091EA,stroke:#01579B,stroke-width:2px

  %% After μ¤νƒ€μΌ
  style A1 fill:#FFF59D,stroke:#FBC02D
  style B1 fill:#FFE082,stroke:#F57F17
  style C1 fill:#FFAB91,stroke:#D84315
  style D1 fill:#B2EBF2,stroke:#0097A7
  style E1 fill:#B2DFDB,stroke:#00796B
  style F1 fill:#DCEDC8,stroke:#558B2F
  style G1 fill:#D1C4E9,stroke:#6A1B9A

  %% Before μ¤νƒ€μΌ
  style A fill:#FFF59D,stroke:#FBC02D
  style B fill:#FFE082,stroke:#F57F17
  style C fill:#B2EBF2,stroke:#0097A7
  style D fill:#B2DFDB,stroke:#00796B
  style E fill:#DCEDC8,stroke:#558B2F

```



## 3. Code Description (μ½”λ“ μ„¤λ…)

- **`SenderTask(void *pvParameters)` (μ†΅μ‹  νƒμ¤ν¬)**
  - `pvPortMalloc()`μ„ μ‚¬μ©ν•μ—¬ 50λ°”μ΄νΈ ν¬κΈ°μ λ©”λ¨λ¦¬ λΈ”λ΅μ„ λ™μ μΌλ΅ ν• λ‹Ήν•©λ‹λ‹¤.
  - `snprintf()`λ¥Ό μ‚¬μ©ν•μ—¬ ν• λ‹Ήλ λ©”λ¨λ¦¬μ— "Hello from SenderTask [λ²νΈ]" ν•μ‹μ λ¬Έμμ—΄μ„ μ €μ¥ν•©λ‹λ‹¤.
  - `xQueueSendToBack()` ν•¨μλ¥Ό μ‚¬μ©ν•μ—¬ μƒμ„±λ λ¬Έμμ—΄μ **ν¬μΈν„°**λ¥Ό νλ΅ μ „μ†΅ν•©λ‹λ‹¤.
  - 100ms λ§λ‹¤ μ΄ κ³Όμ •μ„ λ°λ³µν•©λ‹λ‹¤.

- **`ReceiverTask(void *pvParameters)` (μμ‹  νƒμ¤ν¬)**
  - `xQueueReceive()` ν•¨μλ¥Ό μ‚¬μ©ν•μ—¬ νλ΅λ¶€ν„° ν¬μΈν„°λ¥Ό μμ‹ ν•©λ‹λ‹¤.
  - μμ‹ λ ν¬μΈν„°κ°€ κ°€λ¦¬ν‚¤λ” λ©”λ¨λ¦¬μ λ¬Έμμ—΄μ„ μ‹λ¦¬μ–Ό ν¬νΈλ΅ μ¶λ ¥ν•©λ‹λ‹¤.
  - **`vPortFree()`**λ¥Ό νΈμ¶ν•μ—¬ μμ‹ λ ν¬μΈν„°κ°€ κ°€λ¦¬ν‚¤λ” λ©”λ¨λ¦¬λ¥Ό **ν•΄μ **ν•©λ‹λ‹¤. μ΄λ” λ©”λ¨λ¦¬ λ„μ(Memory Leak)λ¥Ό λ°©μ§€ν•λ” λ§¤μ° μ¤‘μ”ν• κ³Όμ •μ…λ‹λ‹¤.

- **`main(void)`**
  - `Driver_Init()`λ¥Ό νΈμ¶ν•μ—¬ MCUμ ν•λ“μ›¨μ–΄λ¥Ό μ΄κΈ°ν™”ν•©λ‹λ‹¤.
  - `xQueueCreate()`λ¥Ό μ‚¬μ©ν•μ—¬ ν¬κΈ°κ°€ 5μ΄κ³ , `char*` (λ¬Έμμ—΄ ν¬μΈν„°) νƒ€μ…μ λ°μ΄ν„°λ¥Ό μ €μ¥ν•  μ μλ” νλ¥Ό μƒμ„±ν•©λ‹λ‹¤.
  - `xTaskCreate` ν•¨μλ¥Ό μ‚¬μ©ν•μ—¬ `SenderTask`μ™€ `ReceiverTask`λ¥Ό μƒμ„±ν•©λ‹λ‹¤.
    - `SenderTask` μ°μ„ μμ„: 1
    - `ReceiverTask` μ°μ„ μμ„: 2 (λ” λ†’μ)
  - `vTaskStartScheduler()`λ¥Ό νΈμ¶ν•μ—¬ FreeRTOS μ¤μΌ€μ¤„λ¬λ¥Ό μ‹μ‘ν•©λ‹λ‹¤.

## 4. Expected Output (μμƒ κ²°κ³Ό)

`SenderTask`κ°€ λ™μ μΌλ΅ λ¬Έμμ—΄μ„ μƒμ„±ν•μ—¬ ν¬μΈν„°λ¥Ό νμ— λ„£μΌλ©΄, μ°μ„ μμ„κ°€ λ” λ†’μ€ `ReceiverTask`κ°€ μ¦‰μ‹ ν•΄λ‹Ή ν¬μΈν„°λ¥Ό μμ‹ ν•μ—¬ λ¬Έμμ—΄μ„ μ¶λ ¥ν•κ³  λ©”λ¨λ¦¬λ¥Ό ν•΄μ ν•©λ‹λ‹¤. μ΄ κ³Όμ •μ΄ κ³„μ† λ°λ³µλ©λ‹λ‹¤.

### 5.1. μ‹λ¦¬μ–Ό μ¶λ ¥ (Serial Output)

μ‹λ¦¬μ–Ό ν„°λ―Έλ„μ—μ„λ” `SenderTask`μ™€ `ReceiverTask`κ°€ λ²κ°μ•„ μ¶λ ¥ν•λ” λ©”μ‹μ§€λ¥Ό λ³Ό μ μμµλ‹λ‹¤.

```
Hello from SenderTask 0
Hello from SenderTask 0
Hello from SenderTask 1
Hello from SenderTask 1
Hello from SenderTask 2
Hello from SenderTask 2
...
```

## 6. λ™μ‘ μ›λ¦¬ (Mermaid Diagram)

```mermaid
sequenceDiagram
    participant SenderTask
    participant Queue
    participant ReceiverTask

    loop
        SenderTask->>+SenderTask: 1. pvPortMalloc()λ΅ λ©”λ¨λ¦¬ ν• λ‹Ή
        SenderTask->>+SenderTask: 2. snprintf()λ΅ λ¬Έμμ—΄ μƒμ„±
        SenderTask->>Queue: 3. xQueueSendToBack(ν¬μΈν„°)
        note right of SenderTask: ν¬μΈν„°λ¥Ό νμ— λ³µμ‚¬

        ReceiverTask->>Queue: 4. xQueueReceive(ν¬μΈν„° μμ‹ )
        note left of ReceiverTask: νμ—μ„ ν¬μΈν„° κ°€μ Έμ¤κΈ°
        ReceiverTask->>+ReceiverTask: 5. μμ‹ λ λ¬Έμμ—΄ μ²λ¦¬ (UART μ¶λ ¥)
        ReceiverTask->>+ReceiverTask: 6. vPortFree()λ΅ λ©”λ¨λ¦¬ ν•΄μ 
    end
```

## 7. ν•µμ‹¬ κ°λ…: ν¬μΈν„° μ „λ‹¬μ μ¥μ κ³Ό μ£Όμμ 

- **μ¥μ **: ν° λ°μ΄ν„°(μ: κΈ΄ λ¬Έμμ—΄, κµ¬μ΅°μ²΄)λ¥Ό νλ΅ μ „λ‹¬ν•  λ•, λ°μ΄ν„° μ „μ²΄λ¥Ό λ³µμ‚¬ν•λ” λ€μ‹  4λ°”μ΄νΈ(32λΉ„νΈ μ‹μ¤ν… κΈ°μ¤€) ν¬μΈν„°λ§ μ „λ‹¬ν•λ―€λ΅ λ§¤μ° λΉ λ¥΄κ³  ν¨μ¨μ μ…λ‹λ‹¤. ν μμ²΄μ λ©”λ¨λ¦¬ μ‚¬μ©λ‰λ„ μ¤„μΌ μ μμµλ‹λ‹¤.

- **μ£Όμμ **: 
  - **λ©”λ¨λ¦¬ μ†μ κ¶(Ownership)**: ν¬μΈν„°λ¥Ό μ „λ‹¬ν•  λ•λ” λ„κ°€ λ©”λ¨λ¦¬λ¥Ό ν• λ‹Ήν•κ³  ν•΄μ ν•  μ±…μ„μ΄ μλ”μ§€ λ…ν™•ν ν•΄μ•Ό ν•©λ‹λ‹¤. μ΄ μμ μ—μ„λ” `SenderTask`κ°€ ν• λ‹Ήν•κ³  `ReceiverTask`κ°€ ν•΄μ ν•©λ‹λ‹¤.
  - **λ©”λ¨λ¦¬ λ„μ(Memory Leak)**: `ReceiverTask`μ—μ„ `vPortFree()`λ¥Ό νΈμ¶ν•μ§€ μ•μΌλ©΄, `SenderTask`κ°€ κ³„μ†ν•΄μ„ ν• λ‹Ήν•λ” λ©”λ¨λ¦¬κ°€ ν•΄μ λμ§€ μ•μ•„ κ²°κµ­ μ‹μ¤ν…μ ν™(Heap) λ©”λ¨λ¦¬κ°€ κ³ κ°λ©λ‹λ‹¤.
  - **λ•κΈ€λ§ ν¬μΈν„°(Dangling Pointer)**: λ©”λ¨λ¦¬κ°€ ν•΄μ λ ν›„μ—λ„ ν•΄λ‹Ή ν¬μΈν„°λ¥Ό μ‚¬μ©ν•λ ¤κ³  ν•λ©΄ μκΈ°μΉ μ•μ€ λ™μ‘μ΄λ‚ μ‹μ¤ν… μ¶©λμ΄ λ°μƒν•  μ μμµλ‹λ‹¤.
